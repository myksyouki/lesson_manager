# サブスクリプション機能実装プラン

以下はApple App StoreおよびGoogle Play向けのサブスク機能実装に必要な設計および導入手順の概要です。

## 1. 要件定義と全体フローの整理
- 対象プラットフォーム：iOS / Android
- プラン情報
  - **スタンダードプラン**：無料
    - レッスン音声アップロード：4回/月
    - チャット：スタンダードモデルのみ使用可能
  - **プロフェッショナルプラン**：¥980／月
    - レッスン音声アップロード：無制限
    - チャット：アーティストモデルも使用可能
  - 無料トライアル期間：設けない
  - 中途解約後の猶予期間：購読キャンセルまで
- ユーザー体験フロー
  1. プラン一覧画面表示（スタンダード / プレミアム）
  2. プラン選択 → 課金リクエスト発行
  3. レシート取得・サーバー検証
  4. Firestoreへのサブスク情報保存
  5. サブスク管理画面で状態表示／解約・復元

## 2. ストア側セットアップ
- **Apple App Store Connect**
  - プロダクトID（SKU）登録（例：com.lessonmanager.standard、com.lessonmanager.premium）
  - Shared Secret（レシート検証用）取得
  - Sandboxテストユーザー設定
- **Google Play Console**
  - プロダクトID登録
  - ライセンスキー／サービスアカウントJSON取得（サーバー検証用）
  - テストユーザー設定（内部テスト版）
- サブスクリプショングループの定義：今回は不要
- 販売地域・通貨設定：日本（円）

## 3. バックエンド設計
- **レシート検証**
  - Firebase Functions／自前サーバーで各ストアAPIにリクエスト
  - 検証結果に応じた正常／異常ハンドリング
- **Firestore スキーマ**
  - `users/{uid}/subscriptions/{productId}` ドキュメント
    - `purchaseDate`: Timestamp
    - `expiryDate`: Timestamp
    - `status`: active / expired / canceled
    - `autoRenewing`: boolean
    - `receipt`: string
  - `users/{uid}` の `subscription` フィールド更新
- **セキュリティルール**
  - サブスクリプション関連ドキュメントへの制限（認証ユーザーのみ書き込み可）

## 4. クライアント実装設計
- **IAP 初期化／接続終了**
  - アプリ起動時またはサブスク画面遷移時に `initConnection` 実行
  - 画面離脱／アンマウント時に `endConnection`
- **UI設計**
  - プラン一覧画面：`getSubscriptions` で取得した情報を表示
  - 購入ボタン／復元ボタン配置
  - 購入完了／エラー時のアラート表示
  - 管理画面：現在のプラン、解約リンク（ストアページへの遷移）
  - 有効期限・次回更新日の表示：必要
- **ナビゲーション**
  - 購入完了後はトップ画面へ遷移
  - 復元完了後に状態リロード

## 5. テスト計画
- **ユニットテスト**
  - レシート検証ロジック（モック）
  - Firestore更新部分の検証
- **E2Eテスト (Detox)**
  - Sandbox環境での購入／復元フロー
- **エラーケースモック**
  - ネットワーク／ストアAPIエラー再現

## 6. リリース手順
- App Store Connect／Google Play Console へのプラン反映
- バージョン番号・バンドルID更新
- プライバシーポリシー／利用規約への言及追加
- スクリーンショットや説明文の登録
- 審査提出時の注意点（テストアカウント情報の提供など） 