# Firebaseデータ構造移行計画

## 現在の構造
現在のFirebaseデータベースは、用途ごとのコレクションを使用しています：

- `chatRooms` - チャットルーム情報
- `lessons` - レッスン情報
- `tasks` - タスク情報
- `userProfiles` - ユーザープロファイル
- `users` - ユーザー情報

各ドキュメントには `user_id` フィールドがあり、所有者を識別しています。

## 目標構造
ユーザーごとのコレクション構造に変更します：

```
users/
  {userId}/
    profile/  (ユーザープロファイル情報)
    lessons/  (ユーザーのレッスンコレクション)
      {lessonId}/  (レッスンドキュメント)
    tasks/    (ユーザーのタスクコレクション)
      {taskId}/    (タスクドキュメント)
    chatRooms/ (ユーザーのチャットルームコレクション)
      {chatRoomId}/ (チャットルームドキュメント)
```

## 実装状況

以下のコンポーネントが実装済みです：

1. Firebase Functions による移行処理
   - `migrateUserData` - 単一ユーザーのデータを移行
   - `migrateAllUsersData` - 全ユーザーのデータを移行（管理者用）

2. サービスの拡張
   - 各サービスクラスに新構造用のメソッドを追加
   - 設定フラグで新旧どちらの構造を使用するか選択可能

3. 管理画面
   - `/admin/db-migration` に移行管理画面を追加

4. セキュリティルールとインデックス
   - 新構造用のセキュリティルールとインデックスを追加

## データ移行手順

### 1. デプロイ
まず、更新したコードとセキュリティルール、インデックスをデプロイします：

```bash
# Firebaseデプロイ
firebase deploy --only functions,firestore:rules,firestore:indexes
```

### 2. 構造切替
管理画面から構造を切り替えます：

1. ブラウザで `/admin/db-migration` にアクセス
2. 「ユーザーベース構造に切り替え」ボタンをクリック

### 3. データ移行
管理画面からデータを移行します：

1. 「現在のユーザーデータを移行」で自分のデータを移行
2. 問題なければ「全ユーザーデータを移行」で全データを移行（管理者のみ）

### 4. 確認と後片付け

移行完了後、以下を実施します：

1. データの整合性確認
2. 古いデータの削除（必要に応じて）
3. 移行関連コードの整理（将来的に）

## 新構造使用手順

アプリケーションは移行中でも自動的に適切なデータ構造を使用します。

- 新構造が有効になると、全サービスが自動的に新しいパスを使用
- 問題が発生した場合は管理画面から従来の構造に戻すことも可能

## 注意事項

- 移行中はデータが両方の構造に存在することがあります
- 移行はバックグラウンドで実行されるため、数分から数時間かかることがあります
- 移行中にエラーが発生した場合は、Failed Usersリストで確認できます 

## テスト環境

プロジェクトには以下のテスト環境が設定されています：

1. **ユニットテスト環境**:
   - Jestテストフレームワーク
   - React Native Testing Library
   - Firebase Functions Test

詳細なテスト環境の設定と実行方法は以下のドキュメントを参照してください：
- [テスト導入ガイド](./TESTING.md) - ユニットテストおよび統合テストのセットアップと実行方法
- [E2Eテスト環境セットアップガイド](./E2E-TESTING.md) - エンドツーエンドテスト環境の構築と実行方法

### テスト実行

```bash
# ユニットテスト実行
yarn test

# E2Eテスト実行（セットアップ後）
yarn e2e
``` 