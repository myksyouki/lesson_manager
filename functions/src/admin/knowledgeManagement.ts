/**
 * 楽器ナレッジベース管理モジュール
 */

import * as admin from 'firebase-admin';

// ナレッジベースを保存するコレクション
const KNOWLEDGE_COLLECTION = 'instrumentKnowledge';

/**
 * 楽器ナレッジのリストを取得する
 */
export async function listInstrumentKnowledge(): Promise<Array<{
  id: string;
  instrument: string;
  updatedAt: FirebaseFirestore.Timestamp | null;
  contentPreview: string;
}>> {
  try {
    const db = admin.firestore();
    const snapshot = await db.collection(KNOWLEDGE_COLLECTION).get();
    
    if (snapshot.empty) {
      return [];
    }
    
    return snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        id: doc.id,
        instrument: data.instrument || doc.id,
        updatedAt: data.updatedAt || null,
        contentPreview: data.content 
          ? `${data.content.substring(0, 100)}${data.content.length > 100 ? '...' : ''}`
          : ''
      };
    });
  } catch (error) {
    console.error('ナレッジリスト取得エラー:', error);
    throw error;
  }
}

/**
 * 楽器ナレッジを取得する
 * @param knowledgeId ナレッジID
 */
export async function getInstrumentKnowledge(knowledgeId: string): Promise<{
  id: string;
  instrument: string;
  content: string;
  updatedAt: FirebaseFirestore.Timestamp | null;
} | null> {
  try {
    const db = admin.firestore();
    const doc = await db.collection(KNOWLEDGE_COLLECTION).doc(knowledgeId).get();
    
    if (!doc.exists) {
      return null;
    }
    
    const data = doc.data();
    
    return {
      id: doc.id,
      instrument: data?.instrument || doc.id,
      content: data?.content || '',
      updatedAt: data?.updatedAt || null
    };
  } catch (error) {
    console.error(`ナレッジ取得エラー (${knowledgeId}):`, error);
    throw error;
  }
}

/**
 * 楽器ナレッジを削除する
 * @param knowledgeId ナレッジID
 */
export async function deleteInstrumentKnowledge(knowledgeId: string): Promise<void> {
  try {
    const db = admin.firestore();
    await db.collection(KNOWLEDGE_COLLECTION).doc(knowledgeId).delete();
    console.log(`ナレッジが削除されました: ${knowledgeId}`);
  } catch (error) {
    console.error(`ナレッジ削除エラー (${knowledgeId}):`, error);
    throw error;
  }
}

/**
 * サポートされている楽器リストを取得
 */
export function getSupportedInstruments(): string[] {
  return [
    'piano', 'violin', 'viola', 'cello', 'contrabass',
    'guitar', 'bass', 'ukulele', 'flute', 'clarinet',
    'saxophone', 'trumpet', 'trombone', 'horn', 'tuba',
    'percussion', 'drums', 'voice', 'choir', 'composition',
    'theory', 'general'
  ];
}

/**
 * 基本的な楽器ナレッジテンプレートを取得
 * @param instrument 楽器名
 */
export function getKnowledgeTemplate(instrument: string): string {
  const instrumentLower = instrument.toLowerCase();
  
  // 一般的なテンプレート
  if (instrumentLower === 'general') {
    return `# 音楽レッスンの基本知識

## 音楽理論の基礎
- 音階：長音階（メジャースケール）と短音階（マイナースケール）
- コード：三和音（トライアド）と七の和音（セブンスコード）
- 調性：長調（メジャーキー）と短調（マイナーキー）

## レッスンの進め方
- ウォームアップと基礎練習
- 音階とアルペジオ
- エチュード（練習曲）
- レパートリー（演奏曲）

## 練習方法
- スロープラクティス（遅いテンポから始める練習法）
- 分割練習（難しい部分を分けて練習する方法）
- メトロノームを使用したリズム練習
- 反復練習の効果的な方法

## 音楽表現
- ダイナミクス（強弱法）：pp, p, mp, mf, f, ff など
- アーティキュレーション：スタッカート、レガート、マルカート
- テンポとリズム：アッチェレランド、リタルダンド、ルバート

## 演奏会準備
- 暗譜のコツ
- 本番前の効果的な練習方法
- ステージ上での心構えとリラクゼーション法`;
  }
  
  // ピアノのテンプレート
  if (instrumentLower === 'piano' || instrumentLower === 'keyboard') {
    return `# ピアノ教育の基礎知識

## 基本テクニック
- 指の独立性：各指を独立して動かす能力の養成
- タッチコントロール：レガート、スタッカート、ノンレガート
- ペダリング：ダンパーペダル、ソステヌートペダル、ソフトペダルの使い方
- 指使い：効率的な指使いの原則と選択方法

## ピアノ特有の奏法
- 和音の弾き方：アルペジオと和音の違い
- 多声音楽の演奏：ポリフォニーとメロディと伴奏の弾き分け
- オクターブとコード：大きな和音の弾き方とテクニック
- トリル、装飾音：正確で明瞭な装飾音の演奏法

## 練習方法
- 分割練習：小さなセクションに分けて集中的に練習
- ハンズセパレート：右手と左手を別々に練習する方法
- リズム練習：リズムバリエーションを用いた練習法
- スロープラクティス：遅いテンポから始める練習法

## 表現技術
- ダイナミクスコントロール：ピアノの音量調整とニュアンス
- フレージング：音楽的な句読点とラインの形成
- アーティキュレーション：音の切り方と繋ぎ方
- 音色：音質のコントロールと変化

## ピアノ教育レパートリー
- 初心者向け教材：バイエル、ブルグミュラー、チェルニー
- 中級者向け教材：ソナチネアルバム、インヴェンション
- 上級者向け教材：ソナタ、エチュード、前奏曲
- 様々な時代とスタイルの作品：バロック、古典派、ロマン派、近現代`;
  }
  
  // 弦楽器の共通テンプレート
  if (['violin', 'viola', 'cello', 'contrabass'].includes(instrumentLower)) {
    return `# ${instrument}レッスンの基礎知識

## 基本テクニック
- 姿勢と楽器の構え方：正しいフォームと身体の使い方
- 左手のポジショニング：正確な音程とフィンガリング
- 右手の弓の使い方：ボウイングテクニックと音色コントロール
- ビブラート：表現豊かな音を作るための揺らし方

## 特有の奏法
- ピチカート：指で弦をはじく奏法
- スピッカート：弓を弦に弾ませる奏法
- マルテレ：打つように弾く強いアクセントのある奏法
- コル・レーニョ：弓の木の部分で弦を叩く奏法

## 練習方法
- スケールとアルペジオ：音階と分散和音の練習
- エチュード：技術向上のための練習曲
- ポジション移動：スムーズな移動のためのエクササイズ
- 弓のコントロール：音色、音量、アーティキュレーションの練習

## 表現技術
- フレージング：音楽的な句読点と呼吸
- ダイナミクス：強弱の付け方と表現
- アンサンブル：他の楽器との合わせ方
- 様々な音楽スタイルの演奏法：バロック、古典派、ロマン派、現代音楽

## レパートリー
- 初心者向け作品：基礎を固めるための小品
- 中級者向け作品：ソナタ、コンチェルト、技術的課題のある作品
- オーケストラスタディ：オーケストラ作品の重要な部分
- ソロと室内楽：ソロ作品とアンサンブル作品の違い`;
  }
  
  // ギター・ベース系のテンプレート
  if (['guitar', 'bass', 'ukulele'].includes(instrumentLower)) {
    return `# ${instrument}レッスンの基礎知識

## 基本テクニック
- 正しいフォームとポジション：効率的な演奏姿勢
- 右手テクニック：ピッキング、フィンガーピッキング、ストローキング
- 左手テクニック：押弦、コード形成、バレーコード
- チューニング：標準チューニングと代替チューニング

## 特有の奏法
- ベンディング：音程を上げる奏法
- ハンマリングオン・プリングオフ：左手だけで音を出す奏法
- スライド：滑らかに音程を移動させる奏法
- ハーモニクス：倍音を使った特殊な音色の出し方

## 理論と応用
- コード理論：メジャー、マイナー、セブンス、拡張コード
- スケール：メジャー、マイナー、ペンタトニック、モード
- リズムパターン：ストラミング、アルペジオ、フィンガーピッキング
- 即興演奏：ソロ、バッキング、コンピング

## 様々なスタイル
- クラシック：フォーマルな読譜と演奏技術
- ロック・ポップス：バンドでの演奏とリフの作り方
- ジャズ：コード進行の理解とインプロヴィゼーション
- フォーク・アコースティック：伴奏とソロの両立

## 練習方法
- テクニカルエクササイズ：速さと正確さを高める練習
- イヤートレーニング：音を聴き取る能力の向上
- リズム練習：メトロノームを使ったタイミングの練習
- レパートリー構築：様々なジャンルと難易度の曲の習得`;
  }
  
  // 管楽器の共通テンプレート
  if (['flute', 'clarinet', 'saxophone', 'trumpet', 'trombone', 'horn', 'tuba'].includes(instrumentLower)) {
    return `# ${instrument}レッスンの基礎知識

## 基本テクニック
- 呼吸法と息のコントロール：効率的な息の使い方
- アンブシュア：正しい口の形と唇の使い方
- フィンガリング：基本的な運指と代替運指
- タンギング：シングル、ダブル、トリプルタンギング

## 音色と表現
- 音色のコントロール：様々な音色を作り出す方法
- ビブラート：表現豊かな音を作るための揺らし方
- ダイナミクス：音量のコントロールと表現
- アーティキュレーション：スタッカート、レガート、テヌート

## 練習方法
- ロングトーン：音質と持続力を高める練習
- スケールとアルペジオ：全調での音階と分散和音の練習
- テクニカルエチュード：技術向上のための練習曲
- 音程練習：正確な音程感覚を養う練習

## 楽器のメンテナンス
- 日常のケア：演奏前後のお手入れ
- 定期的なメンテナンス：プロフェッショナルによるメンテナンス
- トラブルシューティング：一般的な問題と解決法
- 楽器と付属品の選び方：マウスピース、リード等

## レパートリー
- 基礎練習曲：技術向上のためのエチュード
- ソロ作品：独奏曲とピアノ伴奏付きの作品
- オーケストラスタディ：オーケストラ作品の重要な部分
- 室内楽：アンサンブル作品での役割と演奏法`;
  }
  
  // 打楽器のテンプレート
  if (instrumentLower === 'percussion' || instrumentLower === 'drums') {
    return `# ${instrument}レッスンの基礎知識

## 基本テクニック
- グリップ：スティックの正しい持ち方（マッチドグリップ、トラディショナルグリップ）
- ストロークの種類：フルストローク、ダウンストローク、アップストローク
- ルーディメンツ：シングルストローク、ダブルストローク、パラディドル
- 足のテクニック：バスドラム、ハイハットのペダルコントロール

## リズムとタイミング
- 拍子感：様々な拍子とメトロノームを使った練習
- サブディビジョン：音符の細分化と正確なタイミング
- ポリリズム：複数のリズムパターンの同時演奏
- グルーヴとフィール：音楽的なタイムキープとフィーリング

## 様々な打楽器
- ドラムセット：セッティングと各パーツの役割
- マリンバ・ヴィブラフォン：マレットテクニックと音色
- ティンパニ：チューニングと演奏テクニック
- 小物楽器：タンバリン、トライアングル、ウッドブロックなど

## 様々な音楽スタイル
- ロック・ポップス：基本的なビートとフィルイン
- ジャズ：スイング感とコンピング
- ラテン：サンバ、ボサノバ、アフロキューバンリズム
- クラシック：オーケストラでの役割と演奏法

## 練習方法
- テクニカルエクササイズ：スピードと正確さを高める練習
- リズム読解：様々なリズムパターンの読譜と演奏
- インディペンデンス：手足の独立性を高める練習
- アンサンブル練習：他の楽器との合わせ方`;
  }
  
  // 声楽のテンプレート
  if (instrumentLower === 'voice' || instrumentLower === 'choir') {
    return `# ボーカルレッスンの基礎知識

## 発声テクニック
- 呼吸法：横隔膜を使った効率的な呼吸
- 声帯の使い方：健康的な発声と音色のコントロール
- 共鳴：頭声、胸声、ミックスボイスの使い分け
- ビブラート：自然なビブラートの作り方と制御

## 発音と言語
- 母音と子音：明瞭な発音と歌詞の伝え方
- 言語による発音の違い：英語、イタリア語、日本語など
- ディクション：歌詞の明瞭な発音と伝達
- 国際音声記号（IPA）：正確な発音のための表記法

## 表現技術
- フレージング：音楽的な句読点と呼吸の位置
- ダイナミクス：強弱のコントロールと表現
- 感情表現：歌詞の意味を伝えるための表現方法
- ステージプレゼンス：パフォーマンスとしての歌唱

## 様々な歌唱スタイル
- クラシック：オペラ、リート（歌曲）、オラトリオ
- ポップス・ロック：リズム感と現代的な歌唱法
- ジャズ：スキャット、フィーリング、インプロヴィゼーション
- ミュージカル：ストーリーテリングと演技を伴う歌唱

## ボーカルヘルス
- 声の健康管理：ウォームアップとクールダウン
- 声の問題と対処法：嗄声、疲労、風邪の対処
- 食事と生活習慣：声に影響する要因
- 長期的な声の健康：年齢による変化と対応`;
  }
  
  // 作曲・理論のテンプレート
  if (instrumentLower === 'composition' || instrumentLower === 'theory') {
    return `# 音楽理論・作曲の基礎知識

## 和声学
- 和音の構造：三和音、七の和音、拡張和音
- 和声進行：カデンツの種類と機能和声
- 転調：関係調への転調方法と技法
- 非和声音：経過音、刺繍音、倚音などの使い方

## 対位法
- 旋律の書き方：良い旋律の特徴と構造
- 対位法の原則：協和と不協和、動きの独立性
- 模倣技法：カノン、フーガの構造と書き方
- 声部書法：各声部の独立性と関係性

## 楽式論
- 動機と展開：動機の発展と変形
- 楽節構造：フレーズ、センテンス、ピリオド
- 楽曲形式：二部形式、三部形式、ソナタ形式、ロンド形式
- 変奏技法：テーマと変奏の関係性

## オーケストレーション
- 楽器の特性：各楽器の音域、音色、技術的特徴
- 楽器の組み合わせ：効果的な楽器の組み合わせ方
- テクスチャー：ホモフォニー、ポリフォニー、ヘテロフォニー
- バランス：音量と明瞭さのコントロール

## 作曲技法
- 創作過程：アイデアの発展と構成
- 様式とジャンル：様々な時代と様式の特徴
- 現代技法：12音技法、偶然性音楽、ミニマリズム
- 作曲のワークフロー：スケッチから完成までのプロセス`;
  }
  
  // 一般的なテンプレートを返す
  return `# ${instrument}レッスンの基礎知識

## 基本テクニック
- 正しいフォームと姿勢
- 基本的な演奏テクニック
- 音色のコントロール
- 表現技術の基礎

## 音楽理論とその応用
- 楽譜の読み方と解釈
- 音階とコード
- リズムと拍子
- 曲の構造と形式

## 練習方法
- 効果的な練習の進め方
- テクニック向上のためのエクササイズ
- 問題解決のアプローチ
- 自己評価と改善方法

## 演奏スタイルと表現
- 様々な音楽ジャンルとその特徴
- 表現技術と音楽性
- アンサンブルでの演奏方法
- パフォーマンスとステージプレゼンス

## レパートリー
- 初心者向け作品とその教育的価値
- 中級〜上級者のための重要作品
- 歴史的背景と演奏解釈
- 現代の作品と新しい奏法`;
}

/**
 * 楽器名を日本語に変換
 * @param instrument 英語の楽器名
 */
export function translateInstrumentToJapanese(instrument: string): string {
  const translations: { [key: string]: string } = {
    'piano': 'ピアノ',
    'violin': 'バイオリン',
    'viola': 'ビオラ',
    'cello': 'チェロ',
    'contrabass': 'コントラバス',
    'double bass': 'コントラバス',
    'guitar': 'ギター',
    'bass': 'ベース',
    'bass guitar': 'ベースギター',
    'ukulele': 'ウクレレ',
    'flute': 'フルート',
    'clarinet': 'クラリネット',
    'saxophone': 'サックス',
    'trumpet': 'トランペット',
    'trombone': 'トロンボーン',
    'horn': 'ホルン',
    'tuba': 'チューバ',
    'percussion': '打楽器',
    'drums': 'ドラム',
    'voice': 'ボーカル',
    'choir': '合唱',
    'composition': '作曲',
    'theory': '音楽理論',
    'general': '一般'
  };
  
  return translations[instrument.toLowerCase()] || instrument;
} 