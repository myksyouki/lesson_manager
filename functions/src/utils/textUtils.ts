import { openai } from "../config";

/**
 * OpenAI APIã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦ç´„ã™ã‚‹é–¢æ•°
 * @param {string} text è¦ç´„ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
 * @return {Promise<{summary: string, tags: string[]}>} è¦ç´„çµæœã¨ã‚¿ã‚°
 */
export async function summarizeTextWithOpenAI(text: string): Promise<{summary: string, tags: string[]}> {
  console.log("summarizeTextWithOpenAIé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ");
  try {
    // APIã‚­ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
    console.log("OpenAI APIåˆæœŸåŒ–çŠ¶æ…‹:", {
      apiInitialized: openai ? "åˆæœŸåŒ–æ¸ˆã¿" : "æœªåˆæœŸåŒ–",
      apiKeyAvailable: process.env.OPENAI_API_KEY ? "åˆ©ç”¨å¯èƒ½" : "æœªè¨­å®š"
    });
    
    if (!openai) {
      console.error("OpenAI APIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚APIã‚­ãƒ¼ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      console.error("ç’°å¢ƒå¤‰æ•°:", {
        OPENAI_API_KEY: process.env.OPENAI_API_KEY ? "è¨­å®šã‚ã‚Š" : "æœªè¨­å®š",
        FUNCTIONS_CONFIG_OPENAI_API_KEY: process.env.FUNCTIONS_CONFIG_OPENAI_API_KEY ? "è¨­å®šã‚ã‚Š" : "æœªè¨­å®š",
        FUNCTIONS_CONFIG_OPENAI_APIKEY: process.env.FUNCTIONS_CONFIG_OPENAI_APIKEY ? "è¨­å®šã‚ã‚Š" : "æœªè¨­å®š"
      });
      return {
        summary: "APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã¯AIè¦ç´„ãŒåˆ©ç”¨ã§ããªã„çŠ¶æ…‹ã§ã™ã€‚",
        tags: ["è¨­å®šå¿…è¦", "éŸ³æ¥½", "ç·´ç¿’"],
      };
    }

    // ç©ºã®ãƒ†ã‚­ã‚¹ãƒˆã‚„ã”ãçŸ­ã„ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™
    if (!text || text.trim().length < 10) {
      console.log("ãƒ†ã‚­ã‚¹ãƒˆãŒãªã„ã‹éå¸¸ã«çŸ­ã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¦ç´„ã¨ã‚¿ã‚°ã‚’è¿”ã—ã¾ã™ã€‚");
      return {
        summary: "éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€è¦ç´„ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚ˆã‚Šé•·ã„éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚",
        tags: ["ãƒ‡ãƒ¼ã‚¿ä¸è¶³", "éŸ³æ¥½ãƒ¬ãƒƒã‚¹ãƒ³"],
      };
    }

    console.log("ãƒ†ã‚­ã‚¹ãƒˆè¦ç´„ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆæ–‡å­—æ•°: " + text.length + "ï¼‰");

    // è¦ç´„ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const summaryPrompt = `
    ä»¥ä¸‹ã¯æ¥½å™¨ãƒ¬ãƒƒã‚¹ãƒ³ã®æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚  
    ã“ã®å†…å®¹ã‚’**å­¦ç¿’è€…ãŒæŒ¯ã‚Šè¿”ã‚Šã‚„ã™ã„ã‚ˆã†ã«ã€ã‚ã‹ã‚Šã‚„ã™ããƒ»è¦‹ã‚„ã™ãè¦ç´„**ã—ã¦ãã ã•ã„ã€‚  
    å‡ºåŠ›çµæœã¯èª­ã¿ã‚„ã™ããªã‚‹ã‚ˆã†ã€**çµµæ–‡å­—ã‚„è£…é£¾**ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚

    ---

    ã€è¦ä»¶ã€‘
    - å†…å®¹ã‚’ã€Œã‚»ã‚¯ã‚·ãƒ§ãƒ³å˜ä½ã€ã§åˆ†ã‘ã¦æ•´ç†ã—ã¦ãã ã•ã„ã€‚  
      ä¾‹ï¼šåŸºç¤ç·´ç¿’ã€ã‚¨ãƒãƒ¥ãƒ¼ãƒ‰ã€æ›²ã”ã¨ ãªã©ã€‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæ˜ç¢ºã§ãªã„å ´åˆã¯ã€ã€Œã‚»ã‚¯ã‚·ãƒ§ãƒ³1ã€ãªã©ã§åŒºåˆ‡ã£ã¦ãã ã•ã„ã€‚
    - å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ä»¥ä¸‹ã®3é …ç›®ã‚’æ˜ç¢ºã«è¨˜è¿°ã—ã¦ãã ã•ã„ğŸ‘‡
      - ğŸ¯ **æŒ‡æ‘˜å†…å®¹**
      - ğŸ“Œ **ä»Šå¾Œã®èª²é¡Œ**
      - ğŸµ **ç·´ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹**

    - å‡ºåŠ›ã¯**ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**ã«å¾“ã£ã¦ãã ã•ã„ğŸ‘‡  
    - **å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯300å­—ä»¥ä¸Š**ã§ã€ã§ãã‚‹ã ã‘å…·ä½“çš„ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚  
    - è¦ç´„å…¨ä½“ã¯**1000å­—ä»¥ä¸Š**ã¨ã—ã€ç”Ÿå¾’ãŒèª­ã¿è¿”ã—ã¦ç†è§£ã—ã‚„ã™ã„è‡ªç„¶ãªæ—¥æœ¬èªã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚  
    - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ¬æ–‡ã¯å‡ºåŠ›ã›ãšã€ã€Œè¦ç´„ã®ã¿ã€è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚

    ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¾‹ï¼‰ã€‘

    â–  ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ï¼šåŸºç¤ç·´ç¿’ï¼ˆãƒ­ãƒ³ã‚°ãƒˆãƒ¼ãƒ³ãƒ»ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
    1. æŒ‡æ‘˜å†…å®¹ï¼š
    - ãƒ­ãƒ³ã‚°ãƒˆãƒ¼ãƒ³ã§éŸ³ã®ç«‹ã¡ä¸ŠãŒã‚ŠãŒä¸å®‰å®šã€‚éŸ³ã®å§‹ã¾ã‚Šã«é›‘éŸ³ãŒå…¥ã‚Šã‚„ã™ã„å‚¾å‘ãŒã‚ã‚‹ã€‚
    - ã‚¹ã‚±ãƒ¼ãƒ«ç·´ç¿’ã§éŸ³ç¨‹ãŒä¸Šä¸‹ã§ã¶ã‚Œã‚‹å‚¾å‘ã‚ã‚Šã€‚ç‰¹ã«é«˜éŸ³åŸŸã§ã®éŸ³ç¨‹ã®ä¸å®‰å®šã•ãŒç›®ç«‹ã¤ã€‚
    - éŸ³è‰²ã«ãƒ ãƒ©ãŒã‚ã‚Šã€ä¸€å®šã®éŸ³è³ªã‚’ä¿ã¦ã¦ã„ãªã„ç®‡æ‰€ãŒã‚ã‚‹ã€‚

    2. ä»Šå¾Œã®èª²é¡Œï¼š
    - ãƒ­ãƒ³ã‚°ãƒˆãƒ¼ãƒ³ã§éŸ³ã®å®‰å®šæ„Ÿã‚’æ„è­˜ã™ã‚‹ã€‚ç‰¹ã«éŸ³ã®ç«‹ã¡ä¸ŠãŒã‚Šéƒ¨åˆ†ã§ã®å®‰å®šã—ãŸã‚¢ã‚¿ãƒƒã‚¯ã‚’ç¿’å¾—ã™ã‚‹ã€‚
    - ã‚¹ã‚±ãƒ¼ãƒ«ç·´ç¿’ã‚’ä¸€å®šã®ãƒ†ãƒ³ãƒã§ç¢ºå®Ÿã«è¡Œã„ã€å…¨ã¦ã®éŸ³åŸŸã§å‡ç­‰ãªéŸ³è³ªã‚’ç›®æŒ‡ã™ã€‚
    - å‘¼å¸ã®ä»•æ–¹ã‚„å§¿å‹¢ã‚’æ„è­˜ã—ã¦ã€å®‰å®šã—ãŸéŸ³è‰²ã‚’ä½œã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

    3. ç·´ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š
    - ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ã‚’ä½¿ã£ã¦ã€ãƒ­ãƒ³ã‚°ãƒˆãƒ¼ãƒ³ã‚’1éŸ³ãšã¤ä¸å¯§ã«ç·´ç¿’ã™ã‚‹ã€‚ç‰¹ã«éŸ³ã®ç«‹ã¡ä¸ŠãŒã‚Šã«æ³¨æ„ã—ã¦ã€ã‚¯ãƒªãƒ¼ãƒ³ãªã‚¢ã‚¿ãƒƒã‚¯ã‚’å¿ƒãŒã‘ã‚‹ã€‚
    - ã‚¹ã‚±ãƒ¼ãƒ«ã‚’2ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–åˆ†ã€ã‚†ã£ãã‚Šãƒ†ãƒ³ãƒï¼ˆâ™©=60ï¼‰ã‹ã‚‰å§‹ã‚ã€å¾ã€…ã«é€Ÿãã—ã¦ã„ãç·´ç¿’æ³•ã‚’å–ã‚Šå…¥ã‚Œã‚‹ã€‚
    - é¡ã‚’è¦‹ãªãŒã‚‰ç·´ç¿’ã—ã¦å§¿å‹¢ã‚’ç¢ºèªã—ã€æ·±ã„å‘¼å¸ã‚’æ„è­˜ã™ã‚‹ã€‚

    â–  ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ï¼šã‚¨ãƒãƒ¥ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šâ—‹â—‹æ•™æœ¬ ç¬¬3ç•ªï¼‰
    1. æŒ‡æ‘˜å†…å®¹ï¼š
    - â—‹â—‹ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã§æŒ‡ãŒã‚‚ã¤ã‚Œã‚‹ã€‚
    - ãƒªã‚ºãƒ ãŒèµ°ã‚Šã‚„ã™ããªã‚‹ç®‡æ‰€ã‚ã‚Šã€‚

    2. ä»Šå¾Œã®èª²é¡Œï¼š
    - ãƒ•ã‚£ãƒ³ã‚¬ãƒªãƒ³ã‚°ã®ç²¾åº¦å‘ä¸Šã€‚
    - ãƒªã‚ºãƒ ã®å®‰å®šã‚’æ„è­˜ã€‚

    3. ç·´ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š
    - ç‰‡æ‰‹ãšã¤ã‚†ã£ãã‚Šãƒ†ãƒ³ãƒã§ç·´ç¿’ã€‚
    - è­œé¢ã‚’åˆ†å‰²ã—ã¦é‡ç‚¹çš„ã«ç·´ç¿’ã€‚

    â–  ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ï¼šæ›²ï¼ˆæ›²åï¼šã‚¯ãƒ©ãƒªãƒãƒƒãƒˆå”å¥æ›² ç¬¬1æ¥½ç« ï¼‰
    1. æŒ‡æ‘˜å†…å®¹ï¼š
    - å‡ºã ã—ã®éŸ³ã®å…¥ã‚ŠãŒé…ã‚Œã‚‹ã€‚
    - ãƒ–ãƒ¬ã‚¹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒä¸è‡ªç„¶ã€‚

    2. ä»Šå¾Œã®èª²é¡Œï¼š
    - ãƒ•ãƒ¬ãƒ¼ã‚ºé ­ã®å…¥ã‚Šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´ã€‚
    - å‘¼å¸ã®ãƒã‚¤ãƒ³ãƒˆã‚’è­œé¢ã«è¨˜ã™ã€‚

    3. ç·´ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š
    - ãƒ•ãƒ¬ãƒ¼ã‚ºå†’é ­ã ã‘ã‚’ç¹°ã‚Šè¿”ã—ç·´ç¿’ã€‚
    - å‘¼å¸ã®ä½ç½®ã§ãƒ–ãƒ¬ã‚¹ç·´ç¿’ã‚’å–ã‚Šå…¥ã‚Œã‚‹ã€‚

    æ–‡å­—èµ·ã“ã—:
    ${text}
    `;

    // è¦ç´„çµæœã‚’å–å¾—
    let summary = "";
    let tags: string[] = [];

    try {
      console.log("OpenAI APIã‚’ä½¿ç”¨ã—ã¦è¦ç´„ã‚’ç”Ÿæˆã—ã¾ã™");
      
      // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰ã®çŠ¶æ…‹ãƒ­ã‚°
      console.log(`è¦ç´„å‰ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆé•·: ${text.length}æ–‡å­—, OpenAIåˆæœŸåŒ–çŠ¶æ…‹: ${openai ? "åˆæœŸåŒ–æ¸ˆã¿" : "æœªåˆæœŸåŒ–"}`);
      
      // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚ˆã‚Šè©³ç´°ã«è¨­å®š
      const systemPrompt = `
ã‚ãªãŸã¯éŸ³æ¥½æ•™è‚²ã®å°‚é–€å®¶ã§ã™ã€‚ç”Ÿå¾’ã®ãƒ¬ãƒƒã‚¹ãƒ³ã®æ–‡å­—èµ·ã“ã—ã‚’ã€ã‚ã‹ã‚Šã‚„ã™ãæ§‹é€ åŒ–ã•ã‚ŒãŸè¦ç´„ã«å¤‰æ›ã™ã‚‹å½¹å‰²ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®é‡è¦ãªãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ãã ã•ã„ï¼š
1. å¿…ãšæ—¥æœ¬èªã§å¿œç­”ã—ã¦ãã ã•ã„
2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ã¯è¦ç´„ã«ã¯å«ã‚ãªã„ã§ãã ã•ã„
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæä¾›ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å³å¯†ã«å¾“ã£ã¦ãã ã•ã„
4. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€Œâ–  ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ï¼šå†…å®¹ã€ã®å½¢å¼ã§å§‹ã‚ã¦ãã ã•ã„
5. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã¯ã€Œ1. æŒ‡æ‘˜å†…å®¹ã€ã€Œ2. ä»Šå¾Œã®èª²é¡Œã€ã€Œ3. ç·´ç¿’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€ã®3ã¤ã®ãƒ‘ãƒ¼ãƒˆã«åˆ†ã‘ã¦ãã ã•ã„
6. ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒæ˜ç¢ºã§ãªã„å ´åˆã¯ã€å†…å®¹ã‹ã‚‰é©åˆ‡ã«åˆ¤æ–­ã—ã¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†ã‘ã—ã¦ãã ã•ã„
7. å†…å®¹ãŒå°‘ãªã„å ´åˆã§ã‚‚ã€æœ€ä½1000æ–‡å­—ä»¥ä¸Šã®è¦ç´„ã‚’ä½œæˆã—ã¦ãã ã•ã„
8. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè‡ªä½“ã‚’å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ - è¦ç´„ã ã‘ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
`;
      
      // é‡è¦: temperatureå€¤ã‚’ä¸‹ã’ã¦ä¸€è²«æ€§ã‚’é«˜ã‚ã‚‹
      const summaryResponse = await openai.chat.completions.create({
        model: "o3-mini-2025-01-31",
        messages: [
          {
            role: "system",
            content: systemPrompt,
          },
          {
            role: "user",
            content: summaryPrompt,
          },
        ],
        max_completion_tokens: 2000
      });

      // APIå¿œç­”ãƒ­ã‚°
      console.log(`OpenAI APIå¿œç­”: ${JSON.stringify({
        id: summaryResponse.id,
        model: summaryResponse.model,
        usage: summaryResponse.usage,
        choices_length: summaryResponse.choices?.length || 0,
        finish_reason: summaryResponse.choices[0]?.finish_reason || "ä¸æ˜"
      })}`);

      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°ãƒã‚§ãƒƒã‚¯
      if (!summaryResponse.choices || summaryResponse.choices.length === 0) {
        console.error("OpenAI APIã‹ã‚‰ã®å¿œç­”ã«é¸æŠè‚¢ãŒã‚ã‚Šã¾ã›ã‚“");
        throw new Error("APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¨ãƒ©ãƒ¼: å¿œç­”ã«é¸æŠè‚¢ãŒã‚ã‚Šã¾ã›ã‚“");
      }

      const rawSummary = summaryResponse.choices[0]?.message.content || "";
      
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
      if (rawSummary.includes("ã€è¦ä»¶ã€‘") || rawSummary.includes("ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¾‹ï¼‰ã€‘")) {
        console.warn("è¦ç´„ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™");
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆéƒ¨åˆ†ã‚’é™¤å»ã™ã‚‹å‡¦ç†
        summary = cleanupPromptContent(rawSummary);
      } else {
        summary = rawSummary;
      }
      
      // è¦ç´„ãŒç©ºã¾ãŸã¯éå¸¸ã«çŸ­ã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†
      if (!summary || summary.length < 50) {
        console.error("ç”Ÿæˆã•ã‚ŒãŸè¦ç´„ãŒç©ºã¾ãŸã¯éå¸¸ã«çŸ­ã„ã§ã™");
        // ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã®ã§ã¯ãªãã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®šã™ã‚‹
        summary = "AIè¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ãŒä¸ååˆ†ã‹ã€AIå‡¦ç†ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å¾Œã»ã©å†åº¦ãŠè©¦ã—ã„ãŸã ãã‹ã€ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚";
      } else {
        console.log("è¦ç´„ç”Ÿæˆçµæœ:", 
          summary ? `${summary.length}æ–‡å­—ã®è¦ç´„ã‚’ç”Ÿæˆã—ã¾ã—ãŸ` : "è¦ç´„ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ");
        
        // è¦ç´„ã®å…ˆé ­éƒ¨åˆ†ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¦ç¢ºèª
        if (summary) {
          console.log("è¦ç´„ã®å…ˆé ­100æ–‡å­—:", summary.substring(0, 100));
        }
      }
    } catch (summaryError) {
      console.error("è¦ç´„ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", summaryError);
      summary = "è¦ç´„ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å¾Œã»ã©å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ãªå ´åˆã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚";
    }

    // ã‚¿ã‚°ç”Ÿæˆ
    try {
      console.log("ã‚¿ã‚°ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™: OpenAI APIã‚’å‘¼ã³å‡ºã—ã¾ã™");
      
      const tagsPrompt = `
      ä»¥ä¸‹ã¯æ¥½å™¨ãƒ¬ãƒƒã‚¹ãƒ³ã®æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚ã“ã®å†…å®¹ã‹ã‚‰ã€ãƒ¬ãƒƒã‚¹ãƒ³ã«é–¢é€£ã™ã‚‹é‡è¦ãªã‚¿ã‚°ã‚’5ã€œ10å€‹æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
      
      ã€æŠ½å‡ºã™ã¹ãã‚¿ã‚°ã®ç¨®é¡ã€‘
      - æŠ€è¡“çš„è¦ç´ ï¼ˆä¾‹ï¼šãƒ“ãƒ–ãƒ©ãƒ¼ãƒˆã€ã‚¹ã‚¿ãƒƒã‚«ãƒ¼ãƒˆã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚­ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€é‹æŒ‡ã€éŸ³è‰²ã€è¡¨ç¾åŠ›ï¼‰
      - èª²é¡Œã®ç¨®é¡ï¼ˆä¾‹ï¼šãƒªã‚ºãƒ ã€éŸ³ç¨‹ã€å§¿å‹¢ã€å‘¼å¸ã€ãƒ•ã‚£ãƒ³ã‚¬ãƒªãƒ³ã‚°ï¼‰
      - ç·´ç¿’å†…å®¹ï¼ˆä¾‹ï¼šã‚¹ã‚±ãƒ¼ãƒ«ã€ã‚¢ãƒ«ãƒšã‚¸ã‚ªã€ã‚¨ãƒãƒ¥ãƒ¼ãƒ‰ã€æ›²åï¼‰
      - æ¥½æ›²åï¼ˆå®Ÿéš›ã«ãƒ¬ãƒƒã‚¹ãƒ³ã§æ‰±ã£ãŸæ›²ãŒã‚ã‚Œã°ã€ãã®æ›²åï¼‰
      
      ã€å‡ºåŠ›å½¢å¼ã€‘
      - å¿…ãšç®‡æ¡æ›¸ãã§ï¼ˆ- ã‚¿ã‚°åï¼‰ã®å½¢å¼ã§ã‚¿ã‚°ã ã‘ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„
      - ã‚¿ã‚°ã®å‰ã«ã€Œé‡è¦ã‚¿ã‚°ï¼šã€ãªã©ã®è¦‹å‡ºã—ã¯ä¸è¦ã§ã™
      - ã‚¿ã‚°ã¯1ã¤ãšã¤æ”¹è¡Œã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„
      - ä¸€åº¦ç¢ºèªã—ã€ç®‡æ¡æ›¸ãå½¢å¼ã§ãªã„å ´åˆã¯ã€å¿…ãšç®‡æ¡æ›¸ãå½¢å¼ã«ä¿®æ­£ã—ã¦ãã ã•ã„
      
      ã€æ–‡å­—èµ·ã“ã—ãƒ‡ãƒ¼ã‚¿ã€‘
      ${text}
      `;

      const tagsResponse = await openai.chat.completions.create({
        model: "o3-mini-2025-01-31",
        messages: [
          {
            role: "system",
            content: "ã‚ãªãŸã¯éŸ³æ¥½ãƒ¬ãƒƒã‚¹ãƒ³ã®å†…å®¹ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚å¿…ãšæŒ‡å®šã•ã‚ŒãŸç®‡æ¡æ›¸ãå½¢å¼ã§ã‚¿ã‚°ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚",
          },
          {
            role: "user",
            content: tagsPrompt,
          },
        ],
        max_completion_tokens: 500,
      });

      const tagsText = tagsResponse.choices[0]?.message.content || "";
      console.log("ã‚¿ã‚°ç”Ÿæˆçµæœï¼ˆæœªåŠ å·¥ï¼‰:", tagsText);

      // ãƒªã‚¹ãƒˆå½¢å¼ã§è¿”ã•ã‚ŒãŸã‚¿ã‚°ã‚’å‡¦ç†
      // "- ã‚¿ã‚°å" ã®å½¢å¼ã‹ã‚‰ã€ã‚¿ã‚°åã®ã¿ã‚’æŠ½å‡º
      const tagLines = tagsText.split("\n").filter(line => line.trim().startsWith("-"));
      
      if (tagLines.length === 0) {
        // ç®‡æ¡æ›¸ããŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€è¡Œã”ã¨ã«å‡¦ç†
        const lines = tagsText.split("\n").filter(line => line.trim().length > 0);
        tags = lines.map(line => line.trim()
          .replace(/^\d+\.\s*/, "") // æ•°å­—.ã®å½¢å¼ã‚’å‰Šé™¤
          .replace(/^[â€¢*]\s*/, "") // â€¢ã‚„*ã§å§‹ã¾ã‚‹å ´åˆã‚‚å‰Šé™¤
          .replace(/^ãƒ»\s*/, "") // ãƒ»ã§å§‹ã¾ã‚‹å ´åˆã‚‚å‰Šé™¤
          .replace(/^ã€.*ã€‘\s*/, "") // ã€ã€‘ã§å›²ã¾ã‚ŒãŸè¦‹å‡ºã—ã‚’å‰Šé™¤
        ).filter(tag => tag.length > 0 && !tag.includes("ï¼š") && !tag.includes(":"));
        console.log("è¡Œãƒ™ãƒ¼ã‚¹ã§æŠ½å‡ºã—ãŸã‚¿ã‚°:", tags);
      } else {
        // é€šå¸¸ã®ç®‡æ¡æ›¸ãå‡¦ç†
        tags = tagLines.map(line => line.replace(/^-\s*/, "").trim()).filter(tag => tag.length > 0);
        console.log("ç®‡æ¡æ›¸ãã‹ã‚‰æŠ½å‡ºã—ãŸã‚¿ã‚°:", tags);
      }
      
      // ã€Œé‡è¦ã‚¿ã‚°ï¼šã€ãªã©ã®è¡ŒãŒã‚¿ã‚°ã¨ã—ã¦æŠ½å‡ºã•ã‚ŒãŸå ´åˆã€ãã‚Œã‚’é™¤å¤–
      tags = tags.filter(tag => !tag.includes("é‡è¦ã‚¿ã‚°") && !tag.includes("ï¼š") && !tag.includes(":"));
      
      // ã‚¿ã‚°ãŒ0å€‹ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚°ã‚’ä½¿ç”¨
      if (tags.length === 0) {
        console.log("ã‚¿ã‚°ãŒæŠ½å‡ºã§ããªã‹ã£ãŸãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚°ã‚’ä½¿ç”¨ã—ã¾ã™");
        tags = ["éŸ³æ¥½ãƒ¬ãƒƒã‚¹ãƒ³", "ç·´ç¿’", "éŸ³æ¥½"];
      }
    } catch (tagsError) {
      console.error("ã‚¿ã‚°æŠ½å‡ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", tagsError);
    }

    console.log("æœ€çµ‚çš„ãªã‚¿ã‚°:", tags);
    console.log("ãƒ†ã‚­ã‚¹ãƒˆè¦ç´„ãŒå®Œäº†ã—ã¾ã—ãŸ");

    return { summary, tags };
  } catch (error) {
    console.error("ãƒ†ã‚­ã‚¹ãƒˆè¦ç´„ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    return {
      summary: "è¦ç´„ã‚µãƒ¼ãƒ“ã‚¹ã§æŠ€è¡“çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãçµŒã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ã‚µãƒãƒ¼ãƒˆãŒå¿…è¦ãªå ´åˆã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚",
      tags: ["ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ", "ã‚·ã‚¹ãƒ†ãƒ éšœå®³", "ã‚µãƒãƒ¼ãƒˆå¿…è¦"],
    };
  }
}

/**
 * è¦ç´„ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã‚’é™¤å»ã™ã‚‹é–¢æ•°
 * @param {string} rawSummary ç”Ÿæˆã•ã‚ŒãŸè¦ç´„ãƒ†ã‚­ã‚¹ãƒˆ
 * @return {string} ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚ŒãŸè¦ç´„
 */
function cleanupPromptContent(rawSummary: string): string {
  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆéƒ¨åˆ†ã®é™¤å»ãƒ‘ã‚¿ãƒ¼ãƒ³
  const patterns = [
    /ã€è¦ä»¶ã€‘[\s\S]*?(?=â– )/, // ã€è¦ä»¶ã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
    /ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¾‹ï¼‰ã€‘[\s\S]*?(?=â– )/, // ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¾‹ï¼‰ã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
    /æ–‡å­—èµ·ã“ã—:[\s\S]*?(?=â– )/, // æ–‡å­—èµ·ã“ã—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
  ];
  
  let cleanedSummary = rawSummary;
  
  // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å‰Šé™¤ã‚’è©¦è¡Œ
  patterns.forEach(pattern => {
    cleanedSummary = cleanedSummary.replace(pattern, "");
  });
  
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ã‹ã‚‰å§‹ã¾ã‚‹ã“ã¨ã‚’ç¢ºèª
  if (!cleanedSummary.trim().startsWith("â– ")) {
    // æœ€åˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã™
    const sectionIndex = cleanedSummary.indexOf("â– ");
    if (sectionIndex > 0) {
      cleanedSummary = cleanedSummary.substring(sectionIndex);
    }
  }
  
  return cleanedSummary.trim();
}
