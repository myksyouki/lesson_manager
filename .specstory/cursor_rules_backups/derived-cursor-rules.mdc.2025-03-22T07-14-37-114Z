
## PROJECT OVERVIEW

This project aims to create a lesson management system integrated with AI-powered transcription and summarization features.  The system will allow users to upload audio recordings of lessons, generate summaries and tags, and manage their lesson schedules.  Version updates will be noted in the relevant sections.  Dify API and OpenAI Whisper API are used for transcription and summarization. Google Gemini API was added to the tech stack. Node.js 18 runtime will be deprecated on 2025-04-30 and decommissioned on 2025-10-31.  Consider upgrading to Node.js 20 to avoid disruption.  The Dify API requires the "query" parameter for transcription requests and the `conversation_id` parameter. The `app_id` parameter is required for Dify API requests and should be included as `"sys.app_id"` within the `inputs` object. The `timeout` parameter is not supported by Dify API. Ensure proper URL encoding for audio file URLs sent to Dify API using `encodeURI`. The Dify API has a file size limit of 25MB. The maximum audio duration for transcription is 90 minutes. For files larger than 25MB, implement a process to split the audio into smaller chunks before sending to the Whisper API. For files larger than 30MB, a warning will be displayed if not on Wi-Fi. The maximum file size for audio uploads is 100MB and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.  All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required for Dify API requests and should be included within the `inputs` object. The `query` parameter is required for Dify API requests.  The `conversation_id` parameter is required for the Dify API.  The `response_mode` parameter can be "streaming" or "blocking". The `inputs` object should contain key-value pairs for input parameters. The `timeout` parameter is not supported by the Dify API. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  The `sys.app_id` parameter is required. Implement a mechanism to handle large files gracefully, providing warnings to the users when necessary.  Implement robust error handling and logging for all API calls. Implement retry mechanisms for failed API calls with exponential backoff.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  The `sys.app_id` parameter is required. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes.  A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wifi network. All functions must be deployed to the `asia-northeast1` region.  The `sys.app_id` parameter is required for Dify API requests and should be included within the `inputs` object. The `query` parameter is required for Dify API requests. The `conversation_id` parameter is required for the Dify API.  The `response_mode` parameter can be "streaming" or "blocking". The `inputs` object should contain key-value pairs for input parameters. The `timeout` parameter is not supported by the Dify API. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  The `sys.app_id` parameter is required. Implement a mechanism to handle large files gracefully, providing warnings to the users when necessary.  Implement robust error handling and logging for all API calls. Implement retry mechanisms for failed API calls with exponential backoff.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  The `sys.app_id` parameter is required. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes.  A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wifi network. All functions must be deployed to the `asia-northeast1` region. To check Dify API errors, use the Dify management console, workflow debugging features, server log files (if self-hosted), or contact Dify support.  Dify's error logging capabilities may be limited compared to other services.  For detailed API request/response logs, check the browser's DevTools console.  The Dify API has a file upload limit; files exceeding this limit will result in a "413 Request Entity Too Large" error.  User only receives summary and tags; transcription is not provided.  Implement a mechanism to handle large files gracefully, providing warnings to the users when necessary.  Implement robust error handling and logging for all API calls. Implement retry mechanisms for failed API calls with exponential backoff.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  All functions should be deployed to the `asia-northeast1` region.  Lesson data includes `instrument`, `summary`, `tags`, `summaryRequired`, `summaryInProgress`, `transcriptionCompleteTime`, and `transcriptionId` fields.  `instrument` is populated from user profile.  The `generateSummaryFromTranscriptionV2` function will only generate a summary if the `summaryRequired` field is `true` and the lesson's status is `transcribed`.  A mechanism to handle large files gracefully, providing warnings to users when necessary, has been implemented.  Robust error handling and logging for all API calls have been implemented. Retry mechanisms for failed API calls with exponential backoff have been implemented.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  All functions should be deployed to the `asia-northeast1` region.  To check OpenAI API errors, follow these steps: 1. Set the OPENAI_API_KEY environment variable in your Firebase Functions environment. 2. Redeploy your functions to apply the new settings. 3. Check the Firebase Functions logs to monitor function executions and identify errors.  For detailed API request/response logs, check the browser's DevTools console.  The Dify API has a file upload limit; files exceeding this limit will result in "413 Request Entity Too Large" error.  User only receives summary and tags; transcription is not provided.  Implement a mechanism to handle large files gracefully, providing warnings to the users when necessary.  Implement robust error handling and logging for all API calls. Implement retry mechanisms for failed API calls with exponential backoff.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required. All functions should be deployed to the `asia-northeast1` region.  All functions should be deployed to the asia-northeast1 region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.  All functions must be deployed to the `asia-northeast1` region.  Lesson data includes `instrument`, `summary`, `tags`, `summaryRequired`, `summaryInProgress`, `transcriptionCompleteTime`, `transcriptionId`, and `processingId` fields. `instrument` is populated from user profile. The `generateSummaryFromTranscriptionV2` function will only generate a summary if the `summaryRequired` field is `true` and the lesson's status is `transcribed`.  A new `transcriptionId` field has been added to the Lesson data structure to prevent duplicate processing. A new `transcriptionCompleteTime` field has been added to the Lesson data structure.  A mechanism to handle large files gracefully, providing warnings to users when necessary, has been implemented. Robust error handling and logging for all API calls have been implemented. Retry mechanisms for failed API calls with exponential backoff have been implemented. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  All functions should be deployed to the `asia-northeast1` region.  All functions should be deployed to the asia-northeast1 region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  A new `lockAcquiredAt` field has been added to the Lesson data structure. Dify input field settings for transcription (callDifyAPI function):
inputs: {
  instrument: instrumentName,  // 楽器の種類
  file_url: encodeURI(audioUrl),  // 音声ファイルのURL
  user_id: userId,  // ユーザーID
  lesson_id: lessonId  // レッスンID
}
Dify input field settings for summary and tag generation (createLessonSummary function):
inputs: {
  transcription: transcription,  // 文字起こしテキスト
  instrument: instrumentName,  // 楽器の種類
  user_id: userId,  // ユーザーID
  lesson_id: lessonId  // レッスンID
}
To check OpenAI API errors, follow these steps: 1. Set the OPENAI_API_KEY environment variable in your Firebase Functions environment. 2. Redeploy your functions to apply the new settings. 3. Check the Firebase Functions logs to monitor function executions and identify errors.  For detailed API request/response logs, check the browser's DevTools console.  The Dify API has a file upload limit; files exceeding this limit will result in "413 Request Entity Too Large" error.  User only receives summary and tags; transcription is not provided.  Implement a mechanism to handle large files gracefully, providing warnings to the users when necessary.  Implement robust error handling and logging for all API calls. Implement retry mechanisms for failed API calls with exponential backoff.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  All functions should be deployed to the `asia-northeast1` region.  All functions should be deployed to the asia-northeast1 region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.  All functions must be deployed to the `asia-northeast1` region.  A new `transcriptionId` field has been added to the Lesson data structure to prevent duplicate processing.  A mechanism to handle large files gracefully, providing warnings to users when necessary, has been implemented. Robust error handling and logging for all API calls have been implemented. Retry mechanisms for failed API calls with exponential backoff have been implemented. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required. All functions should be deployed to the `asia-northeast1` region. All functions should be deployed to the asia-northeast1 region. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  All functions must be deployed to the `asia-northeast1` region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.  A new `transcriptionId` field has been added to the Lesson data structure to prevent duplicate processing.  A mechanism to handle large files gracefully, providing warnings to users when necessary, has been implemented. Robust error handling and logging for all API calls have been implemented. Retry mechanisms for failed API calls with exponential backoff have been implemented. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  All functions should be deployed to the `asia-northeast1` region.  All functions should be deployed to the asia-northeast1 region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  All functions must be deployed to the `asia-northeast1` region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.  A new `transcriptionId` field has been added to the Lesson data structure to prevent duplicate processing.  A mechanism to handle large files gracefully, providing warnings to users when necessary, has been implemented. Robust error handling and logging for all API calls have been implemented. Retry mechanisms for failed API calls with exponential backoff have been implemented. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required. All functions should be deployed to the `asia-northeast1` region. All functions should be deployed to the asia-northeast1 region. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  To check Dify API errors, use the Dify management console, workflow debugging features, server log files (if self-hosted), or contact Dify support.  Dify's error logging capabilities may be limited compared to other services. For detailed API request/response logs, check the browser's DevTools console. The Dify API has a file upload limit; files exceeding this limit will result in "413 Request Entity Too Large" error. User only receives summary and tags; transcription is not provided. Implement a mechanism to handle large files gracefully, providing warnings to users when necessary. Implement robust error handling and logging for all API calls. Implement retry mechanisms for failed API calls with exponential backoff. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  All functions should be deployed to the `asia-northeast1` region.  All functions should be deployed to the asia-northeast1 region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.  All functions must be deployed to the `asia-northeast1` region.  All functions must be deployed to the `asia-northeast1` region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.  A new `transcriptionId` field has been added to the Lesson data structure to prevent duplicate processing.  A mechanism to handle large files gracefully, providing warnings to users when necessary, has been implemented. Robust error handling and logging for all API calls have been implemented. Retry mechanisms for failed API calls with exponential backoff have been implemented. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  All functions should be deployed to the `asia-northeast1` region.  All functions should be deployed to the asia-northeast1 region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  Lesson data includes `instrument`, `summary`, `tags`, `summaryRequired`, `summaryInProgress`, `transcriptionCompleteTime`, `transcriptionId`, `processingId`, and `lockAcquiredAt` fields. `instrument` is populated from user profile. The `generateSummaryFromTranscriptionV2` function will only generate a summary if the `summaryRequired` field is `true` and the lesson's status is `transcribed`. A new `transcriptionCompleteTime` field has been added to the Lesson data structure.  A new `transcriptionId` field has been added to the Lesson data structure to prevent duplicate processing.  A mechanism to handle large files gracefully, providing warnings to users when necessary, has been implemented. Robust error handling and logging for all API calls have been implemented. Retry mechanisms for failed API calls with exponential backoff have been implemented. The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region. The `sys.app_id` parameter is required.  All functions should be deployed to the `asia-northeast1` region.  All functions should be deployed to the asia-northeast1 region.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network. All functions must be deployed to the `asia-northeast1` region.  A new `lockAcquiredAt` field has been added to the Lesson data structure. All functions should be deployed to the `asia-northeast1` region.


## CODE STYLE

Maintain consistent code style throughout the project.  Use TypeScript for type safety and maintainability. Adhere to standard TypeScript naming conventions.

## FOLDER ORGANIZATION

The project follows a feature-based folder structure.  All components, services, and hooks related to a specific feature are organized within their respective folders under `app/features`.  Assets are stored in `app/assets`.

## TECH STACK

- React Native
- TypeScript
- Firebase (Firestore, Storage, Functions)
- OpenAI Whisper API
- Google Gemini API
- fluent-ffmpeg
- @ffmpeg-installer/ffmpeg
- fs-extra
- form-data
- @types/fluent-ffmpeg
- @types/fs-extra
- @types/form-data
- @react-native-community/netinfo
- @google/generative-ai

## PROJECT-SPECIFIC STANDARDS

- All audio files must be in MP3, WAV, or M4A format.
- Maximum audio file size: 100MB
- Maximum audio duration: 90 minutes
- All functions must be deployed to the `asia-northeast1` region.
- The `sys.app_id` parameter is required for Dify API requests.  This parameter is no longer needed since Dify has been removed.
- The `query` parameter is required for Dify API requests. This parameter is no longer needed since Dify has been removed.
- The `conversation_id` parameter is required for Dify API requests. This parameter is no longer needed since Dify has been removed.
- The `response_mode` parameter can be "streaming" or "blocking".
- The `inputs` object should contain key-value pairs for input parameters.
- The `timeout` parameter is not supported by the Dify API. This parameter is no longer needed since Dify has been removed.
-  A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.
- Lesson data includes `instrument`, `summary`, `tags`, `summaryRequired`, `summaryInProgress`, `transcriptionCompleteTime`, `transcriptionId`, `processingId`, and `lockAcquiredAt` fields.  `instrument` is populated from user profile.
- The `generateSummaryFromTranscriptionV2` function will only generate a summary if the `summaryRequired` field is `true` and the lesson's status is `transcribed`.


## WORKFLOW & RELEASE RULES

- Follow the standard Gitflow branching model.
- Create pull requests for all code changes.
- Code reviews are mandatory before merging any pull request.
- All deployments should be done through Firebase CLI.  All functions should be deployed to the `asia-northeast1` region.

## REFERENCE EXAMPLES

-  Examples of using the OpenAI Whisper API and Google Gemini API should be documented in the project's wiki.

## PROJECT DOCUMENTATION & CONTEXT SYSTEM

- Maintain up-to-date documentation using Markdown format.
- Version updates will be noted in the relevant sections.
- Use a consistent naming convention for all files and folders.  All functions should be deployed to the `asia-northeast1` region.

## DEBUGGING

- Use Firebase console for debugging Cloud Functions.
- Use browser's DevTools console for debugging frontend API calls.
- Implement robust logging for all API calls.

## FINAL DOs AND DON'Ts

- **DO** use TypeScript for all new code.
- **DO** write unit tests for all new features.
- **DO** use Firebase Functions for backend logic.
- **DO** document all API calls and their parameters.
- **DO** handle errors gracefully and provide informative error messages to users.
- **DON'T** commit any unnecessary files to the repository.
- **DON'T** hardcode API keys or sensitive information in the code.
- **DON'T** use deprecated libraries or APIs.
- **DON'T** introduce breaking changes without proper communication and testing.
- **DON'T** use the `timeout` parameter in Dify API requests.  The maximum file size for audio uploads is 100MB, and the maximum audio duration is 90 minutes. A warning will be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.  All functions must be deployed to the `asia-northeast1` region.  The `sys.app_id` parameter is required for Dify API requests. This parameter is no longer needed since Dify has been removed.  The `query` parameter is required for Dify API requests. This parameter is no longer needed since Dify has been removed.  The `conversation_id` parameter is required for Dify API requests. This parameter is no longer needed since Dify has been removed.  The `response_mode` parameter can be "streaming" or "blocking".  The `inputs` object should contain key-value pairs for input parameters.  The `timeout` parameter is not supported by the Dify API. This parameter is no longer needed since Dify has been removed.  The maximum file size for audio uploads is 100MB and the maximum audio duration is 90 minutes.  A warning should be displayed to the user if they are attempting to upload a file larger than 30MB over a non-Wi-Fi network.